name: CI/CD to Yandex Cloud

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      CR_REGISTRY: ${{ secrets.YC_CR_REGISTRY }}
      CR_REPO: ${{ secrets.YC_CR_REPO }}
      IMAGE_NAME: image-uploader
      KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Build & Publish
      run: |
        dotnet publish -c Release -o out

    - name: Debug secrets
      run: |
        echo "CR_REGISTRY length: ${#CR_REGISTRY}"
        echo "CR_REPO length: ${#CR_REPO}"
        if [ -z "$CR_REGISTRY" ]; then echo "ERROR: CR_REGISTRY is empty!"; fi
        if [ -z "$CR_REPO" ]; then echo "ERROR: CR_REPO is empty!"; fi

    - name: Build Docker image
      run: |
        docker build -t $CR_REGISTRY/$CR_REPO/$IMAGE_NAME:latest .
    
    - name: Login to YCR
      run: |
        echo ${{ secrets.YC_CR_TOKEN }} | docker login --username oauth --password-stdin $CR_REGISTRY

    - name: Push image
      run: |
        docker push $CR_REGISTRY/$CR_REPO/$IMAGE_NAME:latest

    - name: Install Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

    - name: Set up Kubeconfig
      run: |
        pip3 install pyyaml
        echo "$KUBE_CONFIG" > kubeconfig.yaml
        python3 << 'EOF'
        import yaml
        import sys
        
        with open('kubeconfig.yaml', 'r') as f:
            config = yaml.safe_load(f)
        
        if 'users' in config:
            for user in config['users']:
                if 'user' in user and 'exec' in user['user']:
                    exec_config = user['user']['exec']
                    if 'command' in exec_config:
                        # Заменяем любой путь к yc.exe на просто yc
                        if 'yc.exe' in exec_config['command'] or 'yc' in exec_config['command']:
                            exec_config['command'] = 'yc'
        
        with open('kubeconfig.yaml', 'w') as f:
            yaml.dump(config, f, default_flow_style=False)
        EOF

    - name: Deploy to Yandex Cloud K8s
      run: |
        export YC_TOKEN="${{ secrets.YC_CR_TOKEN }}"
        kubectl --kubeconfig kubeconfig.yaml apply -f k8s-deployment.yaml --validate=false

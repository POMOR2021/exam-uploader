name: CI/CD to Yandex Cloud

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      CR_REGISTRY: ${{ secrets.YC_CR_REGISTRY }}
      CR_REPO: ${{ secrets.YC_CR_REPO }}
      IMAGE_NAME: image-uploader
      KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Build & Publish
      run: |
        dotnet publish -c Release -o out

    - name: Debug secrets
      run: |
        echo "CR_REGISTRY length: ${#CR_REGISTRY}"
        echo "CR_REPO length: ${#CR_REPO}"
        if [ -z "$CR_REGISTRY" ]; then echo "ERROR: CR_REGISTRY is empty!"; fi
        if [ -z "$CR_REPO" ]; then echo "ERROR: CR_REPO is empty!"; fi

    - name: Build Docker image
      run: |
        docker build -t $CR_REGISTRY/$CR_REPO/$IMAGE_NAME:latest .
    
    - name: Login to YCR
      run: |
        echo ${{ secrets.YC_CR_TOKEN }} | docker login --username oauth --password-stdin $CR_REGISTRY

    - name: Push image
      run: |
        docker push $CR_REGISTRY/$CR_REPO/$IMAGE_NAME:latest

    - name: Install Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

    - name: Set up Kubeconfig and YC Config
      run: |
        pip3 install pyyaml
        echo "$KUBE_CONFIG" > kubeconfig.yaml
        python3 << 'EOF'
        import yaml
        import os
        
        # Читаем kubeconfig
        with open('kubeconfig.yaml', 'r') as f:
            kubeconfig = yaml.safe_load(f)
        
        # Извлекаем cloud-id и folder-id из exec args
        cloud_id = None
        folder_id = None
        
        if 'users' in kubeconfig:
            for user in kubeconfig['users']:
                if 'user' in user and 'exec' in user['user']:
                    exec_config = user['user']['exec']
                    if 'command' in exec_config:
                        # Заменяем любой путь к yc.exe на просто yc
                        if 'yc.exe' in exec_config['command'] or 'yc' in exec_config['command']:
                            exec_config['command'] = 'yc'
                    if 'args' in exec_config:
                        args = exec_config['args']
                        for i, arg in enumerate(args):
                            if arg == '--cloud-id' and i + 1 < len(args):
                                cloud_id = args[i + 1]
                            elif arg == '--folder-id' and i + 1 < len(args):
                                folder_id = args[i + 1]
        
        # Сохраняем исправленный kubeconfig
        with open('kubeconfig.yaml', 'w') as f:
            yaml.dump(kubeconfig, f, default_flow_style=False)
        
        # Создаём конфиг для yc с правильной структурой
        config_dir = f"{os.environ['HOME']}/.config/yandex-cloud"
        os.makedirs(config_dir, exist_ok=True)
        
        # Правильная структура конфига для yc
        profile_config = {
            'token': os.environ.get('YC_CR_TOKEN', '')
        }
        if cloud_id:
            profile_config['cloud-id'] = cloud_id
        if folder_id:
            profile_config['folder-id'] = folder_id
        
        config_data = {
            'profiles': {
                'default': profile_config
            }
        }
        
        with open(f"{config_dir}/config.yaml", 'w') as f:
            yaml.dump(config_data, f, default_flow_style=False)
        
        print(f"Created YC config at {config_dir}/config.yaml")
        print(f"Cloud ID: {cloud_id}, Folder ID: {folder_id}")
        EOF
      env:
        YC_CR_TOKEN: ${{ secrets.YC_CR_TOKEN }}

    - name: Deploy to Yandex Cloud K8s
      run: |
        kubectl --kubeconfig kubeconfig.yaml apply -f k8s-deployment.yaml --validate=false
